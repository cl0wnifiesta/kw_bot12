from aiogram import types
from aiogram.dispatcher.filters import Text
from aiogram.dispatcher import FSMContext

from states.admin_states import CreatePromo
from config import dp, bot, admins, base
from keyboards.admin.admin_kb import cancel_kb

@dp.message_handler(Text(equals="üìÑ–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥"), user_id=admins, state=None)
async def create_promo(message: types.Message, state: FSMContext):
    await CreatePromo.get_promo_text.set()
    async with state.proxy() as data:
        data['message_id'] = (await message.answer("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø—Ä–æ–º–æ–∫–æ–¥–∞:", reply_markup=cancel_kb)).message_id

@dp.message_handler(state=CreatePromo.get_promo_text)
async def get_promo_text(message: types.Message, state: FSMContext):
    await CreatePromo.next()
    async with state.proxy() as data:
        data['text'] = message.text
        await message.delete()
        await bot.edit_message_text("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏:", chat_id=message.from_user.id, message_id=data['message_id'],
                                    reply_markup=cancel_kb)

@dp.message_handler(state=CreatePromo.get_procent)
async def get_promo_text(message: types.Message, state: FSMContext):
    await CreatePromo.next()
    try:
        async with state.proxy() as data:
            data['procent'] = int(message.text)
            await message.delete()
            await bot.edit_message_text("–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª-–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞:",
                                        chat_id=message.from_user.id, message_id=data['message_id'],
                                        reply_markup=cancel_kb)
    except ValueError:
        await message.answer("‚ùå–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–≤–æ–¥!")
        await state.finish()

@dp.message_handler(state=CreatePromo.get_amount_of_usage)
async def get_promo_text(message: types.Message, state: FSMContext):
    await CreatePromo.next()
    try:
        async with state.proxy() as data:
            data['amount_of_usage'] = int(message.text)
            await message.delete()
            await base.add_promo(data['text'], data['procent'], data['amount_of_usage'])
            await bot.edit_message_text("‚úÖ–ü—Ä–æ–º–æ–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!\n\n"
                                        f"–¢–µ–∫—Å—Ç: <strong>{data['text']}</strong>\n"
                                        f"–°–∫–∏–¥–∫–∞: <code>{str(data['procent'])}%</code>\n"
                                        f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π: <code>{str(data['amount_of_usage'])}%</code>",
                                        chat_id=message.from_user.id, message_id=data['message_id'])
    except ValueError:
        await message.answer("‚ùå–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–≤–æ–¥!")
        await state.finish()

@dp.callback_query_handler(Text(equals="adm_cancel"), state="*")
async def adm_cancel(call: types.CallbackQuery, state: FSMContext):
    await call.message.delete()
    await bot.send_message(call.from_user.id, "–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ")
    await state.finish()
